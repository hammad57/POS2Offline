<!DOCTYPE html>
<html>
<head>
    <title>Hammad Mart - Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 15px; }
        #auth-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:999; }
        .login-box { background:white; padding:30px; border-radius:15px; text-align:center; }
        
        .box { background: white; padding: 20px; border-radius: 12px; max-width: 800px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-save { background: #22c55e; color: white; }
        .btn-print { background: #3b82f6; color: white; margin-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; border-radius: 8px; overflow: hidden; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8fafc; color: #64748b; }
        
        /* Row highlighting ONLY when not clicking icons */
        .prod-row:hover { background: #f0fdf4; cursor: pointer; }
        
        .action-area { display: flex; gap: 15px; font-size: 20px; }
        .del-btn { color: #ef4444; cursor: pointer; padding: 5px; }
        .edit-btn { color: #3b82f6; cursor: pointer; padding: 5px; }
        .del-btn:hover, .edit-btn:hover { background: #f1f5f9; border-radius: 5px; }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:20px; text-align:center; width:90%; max-width:380px; position: relative; }
        #print-area { display: none; }

        @media print {
            .no-print { display: none; }
            #print-area { display: grid !important; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; }
            .sticker { border: 1px solid #000; padding: 10px; text-align: center; page-break-inside: avoid; background: white; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h2 style="color:#0f172a">Hammad Mart</h2>
            <input type="number" id="pin" pattern="\d*" inputmode="numeric" placeholder="Enter PIN " style="font-size:20px; text-align:center; width:200px;">
            <button class="btn btn-save" onclick="checkPin()">Unlock Access</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="box no-print">
            <button class="btn btn-print" onclick="printAllLabels()">üñ®Ô∏è Download All QR Labels (PDF)</button>
            <h3 id="form-title" style="margin-top:0;">üõí Add New Product</h3>
            <input type="hidden" id="isEdit" value="false">
            <input type="text" id="pID" placeholder="ID (e.g. 101)">
            <input type="text" id="enName" placeholder="English Name">
            <input type="text" id="urName" placeholder="Urdu Name" dir="rtl">
            <input type="number" id="price" placeholder="Price (Rs)">
            <select id="unit"><option>Per Item</option><option>Per Kg</option><option>Per Liter</option><option>Per Pack</option></select>
            <input type="text" id="img" placeholder="Image URL (Link)">
            <button class="btn btn-save" id="save-btn" onclick="saveData()">Save Product</button>
            <button onclick="resetForm()" style="border:none; background:none; color:#64748b; width:100%; margin-top:10px; cursor:pointer;">+ Clear Form / Add New</button>
        </div>

        <div class="box no-print">
            <h3>Inventory <small style="color:gray; font-weight:normal;">(Click Name for QR)</small></h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>ID</th><th>Product Name</th><th>Price</th><th>Actions</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="qrModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span onclick="closeModal()" style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer;">&times;</span>
            <img id="m-img" style="width:120px; height:120px; border-radius:15px; object-fit:cover; border:2px solid #22c55e;">
            <h2 id="m-en" style="margin:10px 0 5px 0;"></h2>
            <h3 id="m-ur" style="margin:0; color:#22c55e;"></h3>
            <div id="m-qr" style="display:flex; justify-content:center; margin:20px 0;"></div>
            <p id="m-price" style="font-size:28px; font-weight:900; margin:0;"></p>
            <p id="m-id" style="color:gray; font-size:12px; margin-top:5px;"></p>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbx_QoHQzoG7laQkuFHNCKWpMn2z-yPcTak-OJ4AnnRcmCdGBgDRdKJUngwLimgKcoFu1Q/exec";
        let products = [];

        function checkPin() {
            if(document.getElementById('pin').value === "0309") {
                document.getElementById('auth-screen').style.display = "none";
                document.getElementById('main-content').style.display = "block";
                loadData();
            } else { alert("Incorrect PIN!"); }
        }

        async function loadData() {
            const res = await fetch(API + "?action=listAll");
            products = await res.json();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            products.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "prod-row";
                // Detail popup ONLY if clicking the Name/ID part
                tr.onclick = () => showModal(p);
                
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td><b>${p.en}</b><br><span style="color:#22c55e">${p.ur || ''}</span></td>
                    <td>Rs. ${p.pr}</td>
                    <td class="action-area">
                        <span class="edit-btn" title="Edit">‚úèÔ∏è</span>
                        <span class="del-btn" title="Delete">üóëÔ∏è</span>
                    </td>
                `;

                // Attaching events to icons with stopPropagation
                tr.querySelector('.edit-btn').onclick = (e) => {
                    e.stopPropagation(); // Prevents QR modal from opening
                    editP(p);
                };
                tr.querySelector('.del-btn').onclick = (e) => {
                    e.stopPropagation(); // Prevents QR modal from opening
                    deleteP(p.id);
                };

                tbody.appendChild(tr);
            });
        }

        function showModal(p) {
            document.getElementById('m-en').innerText = p.en;
            document.getElementById('m-ur').innerText = p.ur || "";
            document.getElementById('m-price').innerText = "Rs. " + p.pr;
            document.getElementById('m-id').innerText = "ID: " + p.id;
            document.getElementById('m-img').src = p.img || "https://via.placeholder.com/150?text=No+Image";
            document.getElementById('m-qr').innerHTML = "";
            new QRCode(document.getElementById('m-qr'), {text: p.id.toString(), width: 180, height: 180});
            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('qrModal').style.display = 'none'; }

        function saveData() {
            const btn = document.getElementById('save-btn');
            btn.innerText = "Processing...";
            btn.disabled = true;

            const data = {
                action: document.getElementById('isEdit').value === "true" ? "update" : "add",
                id: document.getElementById('pID').value,
                enName: document.getElementById('enName').value,
                urName: document.getElementById('urName').value,
                price: document.getElementById('price').value,
                unit: document.getElementById('unit').value,
                img: document.getElementById('img').value
            };

            fetch(API, {method:'POST', mode:'no-cors', body:JSON.stringify(data)}).then(() => {
                alert("Data Saved Successfully!");
                resetForm();
                loadData();
            }).finally(() => {
                btn.innerText = "Save Product";
                btn.disabled = false;
            });
        }

        function editP(p) {
            document.getElementById('form-title').innerText = "üìù Edit Product";
            document.getElementById('isEdit').value = "true";
            document.getElementById('pID').value = p.id;
            document.getElementById('pID').readOnly = true;
            document.getElementById('enName').value = p.en;
            document.getElementById('urName').value = p.ur;
            document.getElementById('price').value = p.pr;
            document.getElementById('unit').value = p.un;
            document.getElementById('img').value = p.img;
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function deleteP(id) {
            if(confirm("Are you sure you want to delete this product?")) {
                fetch(API, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'delete', id:id})})
                .then(() => loadData());
            }
        }

        function resetForm() {
            document.getElementById('form-title').innerText = "üõí Add New Product";
            document.getElementById('isEdit').value = "false";
            document.getElementById('pID').value = "";
            document.getElementById('pID').readOnly = false;
            document.getElementById('enName').value = "";
            document.getElementById('urName').value = "";
            document.getElementById('price').value = "";
            document.getElementById('img').value = "";
        }

        function printAllLabels() {
            const area = document.getElementById('print-area');
            area.innerHTML = "";
            products.forEach(p => {
                const div = document.createElement('div');
                div.className = "sticker";
                const qid = "q" + p.id;
                div.innerHTML = `<div style="font-size:11px; font-weight:bold;">${p.en}</div><div id="${qid}" style="display:flex; justify-content:center; margin:5px 0;"></div><div style="font-size:13px;">${p.ur || ''}</div>`;
                area.appendChild(div);
                new QRCode(document.getElementById(qid), {text: p.id.toString(), width: 90, height: 90});
            });
            setTimeout(() => window.print(), 1000);
        }
    </script>
</body>
</html>
